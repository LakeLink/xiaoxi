<!--pages/feed/together.wxml-->
<!-- <page-meta page-style="{{ 'overflow: hidden;' }}" /> -->
<view style="padding-bottom: 20px;">
    <view class="card" wx:key="_id" wx:for="{{ togetherDetails }}" style="margin-bottom: 20px;">
        <text class="title">{{item.sportsType}} </text>
        <text class="author">@{{item.host.nickname}}</text>
        <text class="description">{{item.myScheduledAt}} - {{item.location}}</text>
        <rich-text class="content">{{item.description}} </rich-text>
        <swiper wx:if="{{item.images.length}}" style=" height: 200px;" indicator-dots="{{ item.images.length > 1 }}">
            <swiper-item wx:for="{{item.images}}" wx:for-index="imgId" wx:for-item="imgItem">
                <image src="{{imgItem}}" mode="aspectFill" style="width: 100%;" data-idx="{{index}}" data-imgSrc="{{imgItem}}" bindtap="onImgTap"></image>
            </swiper-item>
        </swiper>
        <view class="action">
            <view style="margin-left: 8px; margin-right: 50px;">
                <text style="color: grey; font-size: small;">{{item.deltaPublishedAt}}</text>
            </view>
            <view style="flex-grow: 1; display:flex; justify-content:space-around; ">
                <button size="mini" style="margin: 0" bindtap="onTapOpenPopup" data-idx="{{index}}">{{item.limitedPartners.length + item.waitList.length}}人想去 / {{item.limit}}</button>
                <block wx:if="{{ !item.alreadyJoined }}">
                    <button wx:if="{{ item.unSatisfied }}" size="mini" type="primary" bindtap="onJoin" data-id="{{item._id}}" style="margin: 0;">
                        <van-icon name="smile-comment-o"></van-icon>加我一个
                    </button>
                    <button wx:else size="mini" type="default" bindtap="onJoin" data-id="{{item._id}}" style="margin: 0;">
                        <van-icon name="smile-comment-o"></van-icon>加入候补
                    </button>
                </block>
                <button wx:if="{{ item.alreadyJoined }}" size="mini" style="margin: 0;" bindtap="onQuit" data-id="{{item._id}}">
                    已加入
                </button>
            </view>
        </view>

        <view wx:if="{{item.comments.length > 7 && !showAllComments}}" style="margin-top: 12px; margin-bottom: 4px; margin-left: 8px; font-size: small; color: grey;" bindtap="onShowEarlier">······ 更早 {{item.comments.length-7}} / {{item.comments.length}}</view>
        <view style="margin-top: 8px;">
            <view wx:for="{{item.comments}}" wx:for-item="c">
                <view wx:if="{{ index >= item.comments.length-7 || showAllComments }}">
                    <text style="color: rgb(88, 183, 214);">{{item.commentUserInfo[c.userIndex].nickname}}：</text>
                    <text>{{c.content}}</text>
                </view>
            </view>
        </view>

        <view wx:if="{{showCommentInput}}" style="display: flex; align-items: center; margin-top: 8px">
            <input style="background: #07070707; padding: 6px; margin-right: 4px; border-radius: 4px; flex-grow: 1;" focus="true" placeholder="说点什么..." model:value="{{newComment}}" />
            <button data-id="{{item._id}}" bindtap="onSubmitComment" style="display: inline" size="mini" type="primary" loading="{{sendingComment}}">发送</button>
        </view>

        <view class="action">
            <view style="flex-grow: 1; display:flex; justify-content:space-around; ">
                <button size="mini" style="margin: 0" bindtap="onLike" data-idx="{{index}}">
                    <block wx:if="{{item.alreadyLiked}}">
                        <van-icon style="color: red;" name="like" />
                        <text wx:if="{{item.likedBy.length}}" style="margin-left: 5px; color: pink;">{{item.likedBy.length}}</text>
                    </block>
                    <block wx:else>
                        <van-icon style="color: pink;" name="like" />
                        <text wx:if="{{item.likedBy.length}}" style="margin-left: 5px; color: grey;">{{item.likedBy.length}}</text>
                    </block>
                </button>
                <button size="mini" bindtap="onComment" data-id="{{item._id}}" style="margin: 0;">
                    <van-icon name="smile-comment-o"></van-icon>
                    <text wx:if="{{item.comments.length}}" style="margin-left: 5px; color: grey;">{{item.comments.length}}</text>
                </button>
                <button size="mini" bindtap="onShare" data-id="{{item._id}}" style="margin: 0; height: 100%;">
                    <van-icon name="share-o" />
                </button>
            </view>
        </view>
    </view>
</view>

<van-popup position="bottom" closeable round show="{{ showPopup }}" bind:close="onPopupClose">
    <!-- 下划线显示不正确：https://vant-contrib.gitee.io/vant-weapp/#/tab#qian-tao-popup -->
    <van-tabs wx:if="{{ showPopup }}">
        <van-tab title="伙伴">
            <scroll-view scroll-y style="height: 50vh">
                <van-cell wx:key="_id" wx:for="{{ togetherDetails[popupIndex].partnerInfo }}">
                    <view slot="icon">
                        <image style="width: 50px; height: 50px; padding: 0;" mode="aspectFit" class="avatar" src="{{item.avatarUrl}}"></image>
                    </view>
                    <view slot="title" style="margin-left: 20px; margin-top: 2px;">
                        <text class="main-title">{{ item.nickname }}</text>
                        <text class="second-title">{{ item.realname }}</text>
                    </view>
                </van-cell>
            </scroll-view>
        </van-tab>
        <van-tab title="候补">
            <scroll-view scroll-y style="height: 50vh">
                <van-cell wx:key="_id" wx:for="{{ togetherDetails[popupIndex].waitUserInfo }}">
                    <view slot="icon">
                        <image style="width: 50px; height: 50px; padding: 0;" mode="aspectFit" class="avatar" src="{{item.avatarUrl}}"></image>
                    </view>
                    <view slot="title" style="margin-left: 20px; margin-top: 2px;">
                        <text class="main-title">{{ item.nickname }}</text>
                        <text class="second-title">{{ item.realname }}</text>
                    </view>
                </van-cell>
            </scroll-view>
        </van-tab>
    </van-tabs>
</van-popup>

<navigator url="/pages/together/create">
    <van-icon class="add" size="20px" name="plus" />
</navigator>